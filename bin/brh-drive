#!/bin/bash
# Shortcuts using gdrive
# https://github.com/prasmussen/gdrive

printHelp()
{
    echo "Key Manager options:"
    echo " -h   Print this help and exit"
    echo " -d   Download Keepass DB File"
    echo " -s   Download SSH Keys"
    echo " -u   Upload Keepass DB File"
}

download_file()
{
    fileId=$(gdrive list \
                    | grep "\s$1\s" \
                    | awk '{print $1}')
    gdrive download --id "$fileId" --force
}

download_keepass()
{
    cd ~/Documents
    download_file MyKeePassDatabase.kdbx
}

download_ssh_keys()
{
    cd ~/.ssh
    [ -f brh-key ] || download_file brh-key
    [ -f brh-key.pub ] || download_file brh-key.pub
    [ -f digitalocean ] || download_file digitalocean
    [ -f digitalocean.pub ] || download_file digitalocean.pub
    [ -f id_rsa ] || download_file id_rsa
    [ -f id_rsa.pub ] || download_file id_rsa.pub
    [ -f smilodon_key ] || download_file smilodon_key
    [ -f smilodon_key.pub ] || download_file smilodon_key.pub
    chmod 0400 ./*
    chmod 0600 known_hosts config
}

upload_keepass()
{
    cd ~/Documents
    existingDb=$(gdrive list \
                            | grep "MyKeePassDatabase.kdbx" \
                            | awk '{print $1}')

    echo "Deleting existing DB in gDrive"
    gdrive delete --id "$existingDb"

    parentFolder=$(gdrive list \
                    | grep Keys \
                    | awk '{print $1}')

    echo "Uploading new file to gDrive"
    gdrive upload -f MyKeePassDatabase.kdbx -p "$parentFolder"
}

## ============================================================================
##                                  OptArgs
## ============================================================================
if [ -z "$1" ]; then printHelp; fi

while getopts "hdsu" opt; do
    case $opt in
        h)
            printHelp
            ;;
        d)
            echo "Downloading KeePass file from gDrive" >&2
            download_keepass
            ;;
        s)
            echo "Downloading ssh keys from gDrive" >&2
            download_ssh_keys
            ;;
        u)
            echo "Uploading ~/Documents/MyKeePassDatabase.kdbx to gDrive" >&2
            upload_keepass
            ;;
        \?)
            echo "Invalid option: -$OPTARG" >&2
            exit 1
            ;;
        :)
            echo "Option -$OPTARG requires an argument." >&2
            exit 1
            ;;
    esac
done
